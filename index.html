<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>bench</title>
</head>
<body>
<script>
    function fill(count) {
        let tbs = new Uint32Array(count);
        for (let i = 0; i < tbs.length; i++) {
            tbs[i] = Math.random() * 1000;
        }
        return tbs;
    }

    let workers = new Map();

    for (let i = 1; i < 13; i++) {
        workers[`w${i}`] = new Worker("/worker.js", {type: "module", name: `w${i}`});
    }

    caches.open("enigma").then((cache) => {
        cache.add("/pkg/enigma_bg.wasm");
    });

    async function tTest(worker) {
        return new Promise(resolve => {
            caches.match("/pkg/enigma_bg.wasm").then((response) => response.arrayBuffer())
                .then((wasm) => {
                    readyWorkers[worker].postMessage({wasm}, [wasm]);
                    resolve();
                });

        });
    }

    let readyWorkers = new Map();

    var proxy = new Proxy(readyWorkers, {
        deleteProperty: function (target, property) {
            delete target[property];
            console.log("Deleted %s", property);
            return true;
        },
        set: function (target, property, value, receiver) {
            target[property] = value;
            console.log("Set %s %s", property, value);
            return true;
        }
    });

    let workerPromises = Object.values(workers).map(worker => new Promise(resolve => {
        worker.onmessage = (event) => {
            const {type, recipient} = event.data;
            if (type === "ready") {
                proxy[recipient] = worker; // Assuming proxy setup is correct and intended for other uses
                resolve(); // Resolve the promise when the worker is ready
            }
        };
    }));


    function fulfill() {
        return () => new Promise(resolve => {
            {
                Object.values(workers).forEach((worker) => {
                    worker.onmessage = (event) => {
                        const {type, result} = event.data;
                        if (type === "done") {
                            // console.log(result)
                        }
                    };
                });
                resolve();

            }
        });
    }

    function load() {
        return () => new Promise(resolve => {
            {
                let todos = [];
                for (let i = 0; i < 10000; i++) {
                    Object.keys(readyWorkers).forEach((worker) => {
                        todos.push(tTest(worker));
                    });
                }
                Promise.all(todos).then(() => resolve());

            }
        });
    }

    let now = performance.now();
    Promise.all(workerPromises)
        .then(fulfill())
        .then(load())
        .then(() => {
            console.log(performance.now() - now);
        });


</script>
</body>
</html>
